name: snowflake-devops-demo

on:
  push:
    branches: [ main ]
    paths: [ 'migrations/**' ]
  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.8.x

      - name: Install schemachange
        run: pip install --upgrade pip schemachange

      # 🔐 Recreate private key file from secret
      - name: Write private key
        run: |
          mkdir -p .secrets
          echo "${{ secrets.SF_PRIVATE_KEY_P8_B64 }}" | base64 -d > .secrets/rsa_key.p8
          chmod 600 .secrets/rsa_key.p8

      # 🚀 Run schemachange with key-pair authentication
      - name: Run schemachange (key-pair auth)
        env:
          SF_ACCOUNT:   ${{ secrets.SF_ACCOUNT }}       # e.g. xy12345.us-east-1
          SF_USERNAME:  ${{ secrets.SF_USERNAME }}
          SF_ROLE:      ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE:  ${{ secrets.SF_DATABASE }}
          SF_SCHEMA:    ${{ secrets.SF_SCHEMA }}
        run: |
          schemachange \
            -f "$GITHUB_WORKSPACE/migrations" \
            -a "$SF_ACCOUNT" \
            -u "$SF_USERNAME" \
            -r "$SF_ROLE" \
            -w "$SF_WAREHOUSE" \
            -d "$SF_DATABASE" \
            -s "$SF_SCHEMA" \
            -c "$SF_DATABASE.SCHEMACHANGE.CHANGE_HISTORY" \
            --create-change-history-table \
            --authenticator snowflake_jwt \
            --private-key-path .secrets/rsa_key.p8 \
            -v
